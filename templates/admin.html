<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>管理审核 - 福源堂器材外借</title>
<style>
  body { font-family: "Microsoft YaHei", sans-serif; background:#f7f7f7; padding:20px; }
  h1 { text-align:center; }
  table { width:100%; border-collapse: collapse; background:#fff; }
  th, td { border:1px solid #e5e5e5; padding:8px 10px; font-size:14px; }
  th { background:#fafafa; }
  .actions button { margin-right:6px; padding:6px 10px; cursor:pointer; }
  .badge { padding:2px 8px; border-radius: 999px; font-size:12px; border:1px solid transparent; }
  .badge-pending { background:#fff7e6; border-color:#ffcc80; }
  .badge-approved { background:#e8f5e9; border-color:#a5d6a7; }
  .badge-rejected { background:#ffebee; border-color:#ef9a9a; }
  .topbar { margin: 0 auto 16px; max-width:1200px; display:flex; justify-content:space-between; align-items:center; }
  .topbar a { text-decoration:none; color:#0078D7; }
  .wrap { max-width:1200px; margin:0 auto; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>管理审核</h1>
      <div>
        <a href="/" target="_self">返回首页</a>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>姓名</th>
          <th>电话</th>
          <th>邮箱</th>
          <th>团体名称</th>
          <th>活动名称</th>
          <th>开始</th>
          <th>结束</th>
          <th>地点</th>
          <th>性质</th>
          <th>人数</th>
          <th>器材</th>
          <th>特别需求</th>
          <th>捐款</th>
          <th>方式</th>
          <th>备注</th>
          <th>紧急联系人</th>
          <th>紧急电话</th>
          <th>状态</th>
          <th>操作</th>
          <th>导出</th>
          <th>发送邮件</th>
        </tr>
      </thead>
      <tbody>
        {% for s in submissions %}
        <tr id="row-{{ s[0] }}">
          <td>{{ s[0] }}</td>
          <td class="name-cell">{{ s[1] }}</td>
          <td>{{ s[2] }}</td>
          <td>{{ s[3] }}</td>
          <td>{{ s[4] }}</td>
          <td>{{ s[5] }}</td>
          <td>{{ s[6] }} {{ s[7] }}</td>
          <td>{{ s[8] }} {{ s[9] }}</td>
          <td>{{ s[10] }}</td>
          <td>{{ s[11] }}</td>
          <td>{{ s[12] }}</td>
          <td>{{ s[13] }}</td>
          <td>{{ s[14] }}</td>
          <td>{{ s[15] }}</td>
          <td>{{ s[16] }}</td>
          <td>{{ s[17] }}</td>
          <td>{{ s[18] }}</td>
          <td>{{ s[19] }}</td>
          <td class="status-cell">
            {% set st = s[21] or '' %}
            <span class="badge
              {% if '待' in st %}badge-pending{% elif '通' in st %}badge-approved{% elif '拒' in st %}badge-rejected{% endif %}
            ">{{ st or '待审核' }}</span>
          </td>
          <td class="actions">
            <input type="text" id="comment-{{ s[0] }}" placeholder="审核说明" style="width:120px; margin-bottom:4px;">
            <br>
            <button onclick="updateStatus({{ s[0] }}, '通过')">通过</button>
            <button onclick="updateStatus({{ s[0] }}, '不通过')">不通过</button>
          </td>
          <td><a href="/download/{{ s[0] }}" target="_blank">Word</a></td>
          <td>
            <button onclick="sendReviewEmail({{ s[0] }})">发送邮件</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

<script>
function updateStatus(id, statusText) {
  const comment = document.getElementById(`comment-${id}`).value || "";
  if (!confirm(`确认将编号 ${id} 设置为「${statusText}」吗？`)) return;

  fetch(`/update_status/${id}/${encodeURIComponent(statusText)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ comment: comment })
    })
    .then(r => r.json())
    .then(d => {
      if (!d.success) { alert(d.message || "更新失败"); return; }

      // 更新状态徽章
      const row = document.getElementById(`row-${id}`);
      const cell = row && row.querySelector('.status-cell');
      if (cell) {
        let cls = 'badge';
        const st = d.status || statusText;
        if (st.includes('待') || st.toLowerCase() === 'pending') cls += ' badge-pending';
        else if (st.includes('通') || st.toLowerCase() === 'approved') cls += ' badge-approved';
        else if (st.includes('拒') || st.toLowerCase() === 'rejected') cls += ' badge-rejected';
        cell.innerHTML = `<span class="${cls}">${st}</span>`;
      }
      alert(`已更新。ID: ${d.submission_id}，姓名：${d.name}，状态：${d.status}`);
    })
    .catch(err => {
      console.error(err);
      alert("服务器异常");
    });
}

function sendReviewEmail(id) {
  if (!confirm(`确认向该申请的邮箱发送当前审核结果和说明吗？`)) return;
  fetch(`/send_review_email/${id}`, { method: "POST" })
    .then(r => r.json())
    .then(d => {
      if (!d.success) { alert(d.message || "发送失败"); return; }
      alert(d.message || "已发送");
    })
    .catch(err => {
      console.error(err);
      alert("服务器异常");
    });
}
</script>
</body>
</html>
