<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ç¦æºå ‚å™¨æå¤–å€Ÿç”³è¯·</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            color: #000;
            padding: 20px;
            background-color: #f7f7f7;
        }
        h1, h3 {
            text-align: center;
            font-weight: bold;
            font-size: 28px;
            margin-bottom: 10px;
        }
        h3 { font-size: 18px; }
        form { max-width: 800px; margin: 0 auto; }
        fieldset {
            border: 2px solid #ccc;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        legend { font-weight: bold; font-size: 18px; }
        .form-row { display: flex; align-items: center; margin-bottom: 12px; }
        .form-row label { flex: 0 0 160px; font-weight: bold; }
        .form-row input, .form-row select, .form-row textarea {
            flex: 1; font-family: "Microsoft YaHei", sans-serif; padding: 6px; border: 2px solid #aaa; border-radius: 5px;
        }
        textarea { resize: vertical; }
        .checkbox-group { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 10px; }
        .checkbox-group label { display: flex; align-items: center; font-weight: normal; }
        .checkbox-group input[type="checkbox"] { margin-right: 6px; }
        .equipment-select-all { margin-bottom: 10px; font-weight: bold; }
        .equipment-select-all label { display: flex; align-items: center; }
        button {
            padding: 10px 20px; font-size: 16px; font-family: "Microsoft YaHei", sans-serif;
            border-radius: 6px; border: none; background-color: #0078D7; color: white; cursor: pointer;
        }
        button:hover { background-color: #005ea6; }
        .tabs { text-align: center; margin-bottom: 20px; }
        .tabs button { margin: 0 10px; padding: 8px 16px; font-size: 14px; }
        legend::before { content: "ğŸ“Œ "; }
        #statusForm { max-width: 500px; margin: 15px auto; display: none; }

        /* æ–°å¢ï¼šæŸ¥è¯¢ç»“æœå±•ç¤º */
        .status-result {
            max-width: 500px; margin: 10px auto 0; padding: 12px 14px;
            border-radius: 8px; background: #fff; border: 1px solid #e5e5e5; line-height: 1.6;
        }
        .status-row { display: flex; justify-content: space-between; margin: 6px 0; }
        .badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid transparent; }
        .badge-pending { background:#fff7e6; border-color:#ffcc80; }
        .badge-approved { background:#e8f5e9; border-color:#a5d6a7; }
        .badge-rejected { background:#ffebee; border-color:#ef9a9a; }
        .muted { color:#666; font-size:13px; }
    </style>
</head>
<body>
    <h1>ç¦æºå ‚å™¨æå¤–å€Ÿç”³è¯·</h1>
    <h3>Masland Methodist Church èµ„è®¯å§”å‘˜ä¼š</h3>

    <div class="tabs">
        <button onclick="window.location.href='/'">ç”³è¯·è¡¨æ ¼</button>
        <button onclick="toggleStatusForm()">æŸ¥è¯¢çŠ¶æ€</button>
    </div>

    <!-- æŸ¥è¯¢çŠ¶æ€è¡¨å•ï¼ˆæŒ‰å§“åï¼‰ -->
    <form id="statusForm" action="/check_status" method="get">
        <fieldset>
            <legend>æŸ¥è¯¢å®¡æ ¸çŠ¶æ€</legend>
            <div class="form-row">
                <label for="status_name">å§“å *</label>
                <input type="text" name="name" id="status_name" required>
            </div>
            <div style="text-align: center;">
                <button type="submit">æŸ¥è¯¢</button>
            </div>
            <div id="statusResult" class="status-result" style="display:none;"></div>
        </fieldset>
    </form>

    <form action="/submit" method="post" onsubmit="return validateForm()">
        <fieldset>
            <legend>ç”³è¯·äººä¿¡æ¯</legend>
            <div class="form-row"><label>å§“å *</label><input name="name" id="name" required></div>
            <div class="form-row"><label>è”ç³»ç”µè¯ *</label><input name="phone" id="phone" required></div>
            <div class="form-row"><label>ç”µå­é‚®ç®±</label><input name="email"></div>
            <div class="form-row"><label>æ‰€å±å›¢å¥‘/å°ç»„</label><input name="group"></div>
        </fieldset>

        <fieldset>
            <legend>æ´»åŠ¨ä¿¡æ¯</legend>
            <div class="form-row"><label>æ´»åŠ¨åç§° *</label><input name="event_name" required></div>
            <div class="form-row"><label>å¼€å§‹æ—¥æœŸ *</label><input type="date" name="start_date" required></div>
            <div class="form-row"><label>å¼€å§‹æ—¶é—´ *</label><input type="time" name="start_time" required></div>
            <div class="form-row"><label>ç»“æŸæ—¥æœŸ *</label><input type="date" name="end_date" required></div>
            <div class="form-row"><label>ç»“æŸæ—¶é—´ *</label><input type="time" name="end_time" required></div>
            <div class="form-row"><label>æ´»åŠ¨åœ°ç‚¹ *</label><input name="location" required></div>
            <div class="form-row"><label>æ´»åŠ¨æ€§è´¨ *</label>
                <select name="event_type" required>
                    <option value="">è¯·é€‰æ‹©æ´»åŠ¨æ€§è´¨</option>
                    <option value="å†…éƒ¨">å†…éƒ¨</option>
                    <option value="å¤–å€Ÿ">å¤–å€Ÿ</option>
                </select>
            </div>
            <div class="form-row"><label>é¢„è®¡å‚ä¸äººæ•° *</label><input name="participants" required></div>
        </fieldset>

        <fieldset>
            <legend>å™¨æéœ€æ±‚</legend>
            <div class="equipment-select-all">
                <label><input type="checkbox" id="selectAll" onchange="toggleAllEquipment(this)"> å…¨é€‰å™¨æ</label>
            </div>

            <div class="checkbox-group">
                <label><input type="checkbox" name="equipment" value="éº¦å…‹é£">éº¦å…‹é£</label>
                <label><input type="checkbox" name="equipment" value="æ‰©éŸ³å™¨">æ‰©éŸ³å™¨</label>
                <label><input type="checkbox" name="equipment" value="éŸ³å“ç³»ç»Ÿ">éŸ³å“ç³»ç»Ÿ</label>
                <label><input type="checkbox" name="equipment" value="æŠ•å½±æœº">æŠ•å½±æœº</label>
                <label><input type="checkbox" name="equipment" value="æŠ•å½±å±å¹•">æŠ•å½±å±å¹•</label>
                <label><input type="checkbox" name="equipment" value="å»¶é•¿çº¿">å»¶é•¿çº¿</label>
                <label><input type="checkbox" name="equipment" value="æ¡Œå­">æ¡Œå­</label>
                <label><input type="checkbox" name="equipment" value="æ¤…å­">æ¤…å­</label>
                <label><input type="checkbox" name="equipment" value="è®²å°">è®²å°</label>
                <label><input type="checkbox" name="equipment" value="HDMIçº¿">HDMIçº¿</label>
            </div>

            <div class="form-row">
                <label>ç‰¹æ®Šéœ€æ±‚</label>
                <textarea name="special_request" placeholder="å¦‚æœ‰ç‰¹æ®Šå™¨æéœ€æ±‚æˆ–ä½¿ç”¨è¦æ±‚ï¼Œè¯·åœ¨æ­¤è¯´æ˜"></textarea>
            </div>
        </fieldset>

        <fieldset>
            <legend>æ„Ÿæ©å¥‰çŒ®ï¼ˆå¯é€‰ï¼‰</legend>
            <label>
                <input type="checkbox" name="donation" value="yes" id="donationCheckbox" onchange="toggleDonationMethod()">
                æˆ‘æ„¿æ„ä¸ºæ­¤æ¬¡å™¨æä½¿ç”¨çŒ®ä¸Šæ„Ÿæ©å¥‰çŒ®
            </label>

            <div id="donationMethodContainer" style="margin-top: 10px; display: none;">
                <label for="donation_method" style="display: block; margin-bottom: 5px; font-weight: bold;">è¯·é€‰æ‹©å¥‰çŒ®æ–¹å¼</label>
                <select name="donation_method" id="donation_method" style="padding: 6px; border: 2px solid #aaa; border-radius: 5px; font-family: 'Microsoft YaHei', sans-serif;">
                    <option value="">-- è¯·é€‰æ‹© --</option>
                    <option value="ç°é‡‘">ç°é‡‘</option>
                    <option value="é“¶è¡Œè½¬è´¦">é“¶è¡Œè½¬è´¦</option>
                </select>
            </div>
        </fieldset>

        <fieldset>
            <legend>å…¶ä»–ä¿¡æ¯</legend>
            <div class="form-row"><label>å¤‡æ³¨</label>
                <textarea name="remarks" placeholder="å¦‚æœ‰å…¶ä»–éœ€è¦è¯´æ˜çš„äº‹é¡¹ï¼Œè¯·åœ¨æ­¤å¡«å†™"></textarea>
            </div>
            <div class="form-row"><label>ç´§æ€¥è”ç³»äººå§“å</label><input name="emergency_name" id="emergency_name"></div>
            <div class="form-row"><label>ç´§æ€¥è”ç³»äººç”µè¯</label><input name="emergency_phone" id="emergency_phone"></div>
        </fieldset>

        <div style="text-align: center;">
            <button type="submit">æäº¤ç”³è¯·</button>
        </div>
    </form>

    <script>
        function toggleAllEquipment(source) {
            const checkboxes = document.querySelectorAll('input[name="equipment"]');
            checkboxes.forEach(cb => cb.checked = source.checked);
        }
        function validateForm() {
            const name = document.getElementById("name").value.trim();
            const phone = document.getElementById("phone").value.trim();
            const emergencyName = document.getElementById("emergency_name").value.trim();
            const emergencyPhone = document.getElementById("emergency_phone").value.trim();
            if (emergencyName && emergencyName === name) { alert("âš ï¸ ç´§æ€¥è”ç³»äººå§“åè¦ä¸ç”³è¯·äººå§“åä¸ä¸€è‡´"); return false; }
            if (emergencyPhone && emergencyPhone === phone) { alert("âš ï¸ ç´§æ€¥è”ç³»äººç”µè¯è¦ä¸ç”³è¯·äººè”ç³»ç”µè¯ä¸ä¸€è‡´"); return false; }
            return true;
        }
        function toggleDonationMethod() {
            const checkbox = document.getElementById('donationCheckbox');
            const container = document.getElementById('donationMethodContainer');
            container.style.display = checkbox.checked ? 'block' : 'none';
        }
        function toggleStatusForm() {
            const form = document.getElementById('statusForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        // æŸ¥è¯¢çŠ¶æ€ï¼ˆåŒ…æ‹¬å®¡æ ¸è¯´æ˜ï¼‰
        (function bindStatusLookup(){
            const form = document.getElementById('statusForm');
            const input = document.getElementById('status_name');
            const box = document.getElementById('statusResult');
            if (!form || !input || !box) return;

            form.addEventListener('submit', async function(e){
                e.preventDefault();
                const name = (input.value || '').trim();
                if (!name) { box.style.display='block'; box.textContent='è¯·è¾“å…¥å§“å'; return; }
                box.style.display='block'; box.textContent='æŸ¥è¯¢ä¸­...';

                try {
                    const res = await fetch(`/check_status_api?name=${encodeURIComponent(name)}`);
                    const data = await res.json();

                    if (!data || !data.status) { box.textContent='æœåŠ¡å™¨è¿”å›å¼‚å¸¸ã€‚'; return; }
                    if (data.status === 'not_found') { box.textContent = `æœªæ‰¾åˆ°ã€${name}ã€‘çš„ç”³è¯·è®°å½•ã€‚`; return; }
                    if (data.status === 'error') { box.textContent = data.message || 'æŸ¥è¯¢å‡ºé”™ï¼Œè¯·ç¨åå†è¯•ã€‚'; return; }

                    const s = data.data.review_status;
                    let badgeClass = 'badge';
                    if (s.includes('å¾…') || s.toLowerCase() === 'pending') badgeClass += ' badge-pending';
                    else if (s.includes('é€š') || s.toLowerCase() === 'approved') badgeClass += ' badge-approved';
                    else if (s.includes('æ‹’') || s.toLowerCase() === 'rejected') badgeClass += ' badge-rejected';

                    box.innerHTML = `
                        <div class="status-row"><span class="muted">å§“å</span><strong>${data.data.name}</strong></div>
                        <div class="status-row"><span class="muted">æ´»åŠ¨åç§°</span><strong>${data.data.event_name || '-'}</strong></div>
                        <div class="status-row"><span class="muted">å®¡æ ¸çŠ¶æ€</span><span class="${badgeClass}">${s}</span></div>
                        <div class="status-row"><span class="muted">å®¡æ ¸è¯´æ˜</span><strong>${data.data.review_comment || 'æ— '}</strong></div>
                        <div class="muted" style="margin-top:6px;">ä»¥ä¸Šç»“æœä¸ºæœ€æ–°çŠ¶æ€ï¼Œå¦‚ä¿¡æ¯ä¸ç¬¦ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ ¸å®ã€‚</div>
                    `;
                } catch (err) {
                    box.style.display='block'; box.textContent='ç½‘ç»œæˆ–æœåŠ¡å™¨å¼‚å¸¸ã€‚';
                }
            });
        })();
    </script>
</body>
</html>
