<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>福源堂器材外借申请</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    :root{ --card:#fff; --bd:#e5e5e5; --muted:#666;
      --primary:#0a58ff; --shadow:rgba(0,0,0,.12);}
    body{background:#f7f7f7;color:#000;padding:24px;}
    h1,h2,h3,label,.muted,.tabs button,.nav-title{font-family:"Microsoft YaHei","微软雅黑",sans-serif;}
    h1{font-size:32px;font-weight:900;text-align:center;margin:0 0 6px}
    h3{font-size:16px;text-align:center;margin:0 0 18px;color:#444;font-weight:700}
    .tabs{display:flex;justify-content:center;gap:14px;margin:10px 0 22px}
    .btn-tab{position:relative; padding:10px 18px; border-radius:12px; border:1px solid var(--bd);
      background:#fff; cursor:pointer; font-weight:800;
      box-shadow:0 3px 0 #cfd6ff, 0 8px 16px var(--shadow);}
    .btn-tab:hover{transform:translateY(-1px);}
    form{max-width:1000px;margin:0 auto}
    .card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:16px 18px;margin-bottom:16px;}
    .card h2{display:flex;align-items:center;gap:10px;font-size:20px;font-weight:900;margin:0 0 12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .row{display:flex;flex-direction:column;gap:6px}
    .row label{font-weight:800}
    input,select,textarea{padding:10px;border:1px solid var(--bd);border-radius:10px;background:#fff;}
    .equip-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .equip-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .equip-item{border:1px solid var(--bd);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:6px}
    .equip-left{display:flex;align-items:center;gap:8px}
    .qty{display:none;flex-direction:column;gap:6px;margin-top:6px}
    .qty input{width:90px}
    .muted{color:var(--muted);font-size:13px}
    .btn-submit{padding:12px 22px;border:none;border-radius:12px;background:var(--primary);color:#fff;
      font-weight:900;font-size:16px;cursor:pointer;}
    #statusForm{max-width:520px;margin:0 auto 18px;display:none}
    .status-card{max-width:520px;margin:12px auto 0;padding:12px 14px;border-radius:12px;background:#fff;border:1px solid var(--bd)}
    .status-row{display:flex;justify-content:space-between;margin:6px 0}
  </style>
</head>
<body>
  <h1 class="nav-title">福源堂器材外借申请</h1>
  <h3>Masland Methodist Church 资讯委员会</h3>

  <div class="tabs">
    <button class="btn-tab" onclick="window.location.href='/'">申请表格</button>
    <button class="btn-tab" onclick="toggleStatusForm()">查询状态</button>
  </div>

  <!-- 查询状态 -->
  <form id="statusForm" class="card" onsubmit="return false">
    <h2>查询审核状态</h2>
    <div class="row"><label for="status_name">姓名 *</label>
      <input type="text" id="status_name" required></div>
    <div class="submit-wrap"><button class="btn-submit" type="button" onclick="doLookup()">查询</button></div>
    <div id="statusResult" class="status-card" style="display:none;"></div>
  </form>

  <!-- 主表单 -->
  <form action="/submit" method="post" id="mainForm">
    <!-- 申请人信息 -->
    <section class="card">
      <h2>申请人信息</h2>
      <div class="grid-2">
        <div class="row"><label>姓名 *</label><input type="text" name="name" required></div>
        <div class="row"><label>联系电话 *</label><input type="tel" name="phone" required></div>
        <div class="row"><label>电子邮箱 *</label><input type="email" name="email" required></div>
        <div class="row"><label>所属团契/小组 *</label><input type="text" name="group" required></div>
      </div>
    </section>

    <!-- 活动信息 -->
    <section class="card">
      <h2>活动信息</h2>
      <div class="grid-2">
        <div class="row"><label>活动名称 *</label><input type="text" name="event_name" required></div>
        <div class="row"><label>活动地点 *</label><input type="text" name="location" required></div>
        <div class="row"><label>开始日期 *</label><input type="date" name="start_date" required></div>
        <div class="row"><label>开始时间 *</label><input type="time" name="start_time" required></div>
        <div class="row"><label>结束日期 *</label><input type="date" name="end_date" required></div>
        <div class="row"><label>结束时间 *</label><input type="time" name="end_time" required></div>
        <div class="row"><label>活动性质 *</label>
          <select name="event_type" required>
            <option value="">请选择</option>
            <option value="内部">内部</option>
            <option value="外借">外借</option>
          </select></div>
        <div class="row"><label>预计参与人数 *</label><input type="number" name="participants" min="1" step="1" required></div>
      </div>
    </section>

    <!-- 器材需求 -->
    <section class="card">
      <h2>器材需求</h2>
      <div class="equip-head">
        <div class="muted">请选择需要的器材</div>
        <label><input type="checkbox" id="equip_select_all">全选器材</label>
      </div>
      <div class="equip-grid">
        <!-- ✅ 麦克风特殊 -->
        <div class="equip-item">
          <div class="equip-left">
            <input type="checkbox" id="equip_mic" name="equip_mic">
            <label for="equip_mic">麦克风</label>
          </div>
          <div class="qty" id="qty_mic">
            <div class="row"><label>无线数量</label><input type="number" name="equip_mic_wireless_qty" min="0" step="1" value="0"></div>
            <div class="row"><label>有线数量</label><input type="number" name="equip_mic_wired_qty" min="0" step="1" value="0"></div>
          </div>
        </div>
        <!-- ✅ 其他器材（含信号线） -->
        {% for key, cname in equip_map.items() if key != "mic" %}
        <div class="equip-item">
          <div class="equip-left">
            <input type="checkbox" id="equip_{{key}}" name="equip_{{key}}">
            <label for="equip_{{key}}">{{ cname }}</label>
          </div>
          <div class="qty" id="qty_{{key}}">
            <span class="muted">数量</span>
            <input type="number" name="equip_{{key}}_qty" min="1" step="1" value="1">
          </div>
        </div>
        {% endfor %}
      </div>
      <div class="row" style="margin-top:12px"><label>特殊需求</label><textarea name="special_request"></textarea></div>
    </section>

    <!-- 备注+紧急联系人 -->
    <section class="card">
      <h2>其他信息</h2>
      <div class="grid-2">
        <div class="row"><label>备注</label><textarea name="remarks"></textarea></div>
        <div class="row"><label>紧急联系人姓名</label><input type="text" name="emergency_name"></div>
        <div class="row"><label>紧急联系人电话</label><input type="text" name="emergency_phone"></div>
      </div>
    </section>

    <div class="submit-wrap"><button class="btn-submit" type="submit">提交申请</button></div>
  </form>

<script>
function toggleStatusForm(){const f=document.getElementById('statusForm');f.style.display=(f.style.display==='none'||!f.style.display)?'block':'none';}
async function doLookup(){const name=(document.getElementById('status_name').value||'').trim();const box=document.getElementById('statusResult');if(!name){box.style.display='block';box.textContent='请输入姓名';return;}box.style.display='block';box.textContent='查询中...';try{const res=await fetch(`/check_status_api?name=${encodeURIComponent(name)}`);const data=await res.json();if(!data||!data.status){box.textContent='服务器返回异常';return;}if(data.status==='not_found'){box.textContent=`未找到【${name}】的申请记录。`;return;}const s=data.data.review_status||'';box.innerHTML=`<div class="status-row"><span>姓名</span><b>${data.data.name}</b></div><div class="status-row"><span>活动名称</span><b>${data.data.event_name||'-'}</b></div><div class="status-row"><span>审核状态</span><span>${s}</span></div><div class="status-row"><span>审核说明</span><b>${data.data.review_comment||'无'}</b></div>`;}catch(e){box.textContent='网络异常';}}
(function initEquip(){const ids={{ equip_map.keys()|list|tojson }};const allBox=document.getElementById('equip_select_all');function syncOne(k){const cb=document.getElementById(`equip_${k}`);const box=document.getElementById(`qty_${k}`);const qty=document.querySelector(`input[name="equip_${k}_qty"]`);if(!cb||!box)return;if(cb.checked){box.style.display='flex';if(qty) qty.required=true;}else{box.style.display='none';if(qty) qty.required=false;}}ids.forEach(k=>{const cb=document.getElementById(`equip_${k}`);if(cb){cb.addEventListener('change',()=>syncOne(k));syncOne(k);}});if(allBox){allBox.addEventListener('change',()=>{const on=allBox.checked;ids.forEach(k=>{const cb=document.getElementById(`equip_${k}`);if(cb){cb.checked=on;syncOne(k);}});});}})();
</script>
</body>
</html>
